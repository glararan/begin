/*
    @ 2016 Lukáš Veteška
    Time Table plugin
*/

!function(t,a,e,n){"use strict";function s(t){var a=t.width();t.children(".text").css("width",a+"px")}function r(t){return t===n?"":t}function i(a,e){e=this.options=t.extend({},i.defaults,e),u=moment(),a.append('<div class="col-lg-12" id="ttTop"></div>'),t("#ttTop").append('<div id="ttDetail"></div>'),t("#ttTop").append('<div class="col-lg-4" id="ttTasks"></div>'),t("#ttTop").append('<div class="col-lg-8" id="mapWidget"></div>'),t("#ttDetail").append("<h4>Informace o události</h4>"),t("#ttDetail").append('<form class="form-horizontal"> <div class="form-group"> <label class="col-sm-4 control-label">Název</label> <div class="col-sm-8"> <p class="form-control-static" id="ttDetailName">email@example.com</p></div></div> <div class="form-group"> <label class="col-sm-4 control-label">Adresa</label> <div class="col-sm-8"> <p class="form-control-static" id="ttDetailAddress">email@example.com</p></div></div> <div class="form-group"> <label class="col-sm-4 control-label">Zákazník</label> <div class="col-sm-8"> <p class="form-control-static" id="ttDetailCustomer">email@example.com</p></div></div> </form>'),t("#ttDetail").append('<button class="btn btn-block btn-danger" id="ttDetailClose">Zavřít</button>'),t("#ttTasks").append('<div class="form-group"> <div class="input-group date" data-provide="datepicker" id="datePicker"> <span class="input-group-addon" id="ttPrevDate"><span class="glyphicon glyphicon-chevron-left"></span></span> <input type="text" class="form-control"> <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span> <span class="input-group-addon" id="ttNextDate"><span class="glyphicon glyphicon-chevron-right"></span></span></div></div>'),t("#ttTasks").append('<div class="panel panel-primary"> <div class="panel-heading">Nenaplánované zakázky</div> <div class="panel-body"> <div class="list-group" id="taskList"></div></div></div>'),a.append('<div class="col-lg-12" id="ttBot"></div>'),t("#ttBot").append('<table class="table table-bordered" id="ttTable"></table>')}var o=null,l=null,d=[],c=[],p=[],m=[],u=null,h=null,f=!1,g=0,v=0,b=0,k=null,T=0,D=null;i.prototype={constructor:i,_init:function(){h=this;var n=this,r=this.options;null!=r.resources&&(p=r.resources),null!=r.events&&(m=r.events);for(var i=1/r.accuracy,d="<th>&nbsp;</th>",y=r.firstHour;y<=r.lastHour;y++)d+="<th colspan='"+i+"'>"+y+":00</th>";t("#ttTable").append("<tr>"+d+"</tr>"),t("#ttTop").css("min-height",r.minMapHeight),google.maps.event.addDomListener(a,"load",this._initGoogleMaps),this._load(u),this.showMarkers(),o=t("#datePicker"),o.datetimepicker({format:"DD/MM/YYYY"}),o.on("dp.change",function(a){a.oldDate!=a.date&&null!=a.oldDate&&(null!=r.onDateChange&&r.onDateChange(a.oldDate,a.date),u=moment(a.date),t("#datePicker input").val(u.format("DD/MM/YYYY")),n._load(u),n.showMarkers(),n.zoomOut())}),o=t("#datePicker").data("DateTimePicker"),t("#datePicker input").val(u.format("DD/MM/YYYY")),t("body").on("click","#ttPrevDate",function(a){a.preventDefault();var e=t("#datePicker").data("DateTimePicker").date();e.subtract(1,"d"),t("#datePicker").data("DateTimePicker").date(e),t("#datePicker").data("DateTimePicker").hide()}),t("body").on("click","#ttNextDate",function(a){a.preventDefault();var e=t("#datePicker").data("DateTimePicker").date();e.add(1,"d"),t("#datePicker").data("DateTimePicker").date(e),t("#datePicker").data("DateTimePicker").hide()}),t("body").on("click","#ttTable .subTask, #taskList .list-group-item",function(a){a.preventDefault();for(var e=t(this),n=new google.maps.LatLngBounds,s=0;s<c.length;s++)if(c[s].taskID==e.data("id")){n.extend(c[s].getPosition()),r.zoomOnClick?l.fitBounds(n):l.setCenter(c[s].getPosition());break}}),t("body").on("click",".subTask a",function(a){a.preventDefault(),D&&D.close();for(var e=t(this).parent(),s=t("#ttTable tr td[data-id='"+e.data("resource")+"']:first-child").text(),r=0;r<m.length;r++)if(m[r].id==e.data("id")){for(var i=null,o=0;o<c.length;o++)if(c[o].taskID==m[r].id){i=c[o];break}n.showDetails(i,m[r],s);break}}),t("body").on("click","#ttDetailClose",function(t){t.preventDefault(),n.closeDetails()}),t("body").on("mousedown",".ttDrag",function(a){var e=t("#ttTable tr th:eq(2)");f=!0,g=a.clientX,v=e.width()/parseInt(e.attr("colspan")),b=t(this).parent().width(),k=t(this).parent(),T=parseInt(k.parent().attr("colspan")),k.attr("draggable",!1)}),t(e).on("mousemove",function(t){if(f){var a=g-t.clientX;if(Math.abs(a)>=v-1){var e=k.parent(),n=parseInt(e.attr("colspan"));0>a&&"&nbsp;"==e.next().html()?(e.attr("colspan",n+1),e.next().remove()):a>0&&n>1&&(e.attr("colspan",n-1),e.after("<td>&nbsp;</td>")),s(k),g=t.clientX}}}),t(e).on("mouseup",function(t){if(f&&(f=!1,null!=k)){var a=k.parent(),e=parseInt(a.attr("colspan"))-T,n=k.data("id"),s=60/(1/r.accuracy),i=moment(k.data("end"));i=0>e?i.subtract(s*e,"minutes").format(r.dateFormat):i.add(s*e,"minutes").format(r.dateFormat),k.attr("draggable",!0),k.attr("data-end",i);for(var o=0;o<m.length;o++)if(m[o].id==n){m[o].end=i,null!=r.onUpdate&&r.onUpdate(m[o]);break}k=null}}),t("body").on("dragstart","#taskList .list-group-item, #ttTable .subTask",function(a){var n=this.cloneNode(!0);n.style.position="absolute",n.style.left="-99999px",n.style.top="-99999px",n.id="cloneTask",e.body.appendChild(n),a.originalEvent.dataTransfer.setData("timeTableMove",t(this).hasClass("list-group-item")?0:1),a.originalEvent.dataTransfer.setData("timeTable",t(this).data("id")),a.originalEvent.dataTransfer.setDragImage(n,0,0)}),t("body").on("dragend","#taskList .list-group-item, #ttTable .subTask",function(a){t("#cloneTask").length>0&&t("#cloneTask").remove()}),t("body").on("drop","#ttTable tr td:gt(0)",function(a){if(a.preventDefault(),"&nbsp;"==t(this).html()){var e=a.originalEvent.dataTransfer.getData("timeTable"),i=a.originalEvent.dataTransfer.getData("timeTableMove"),o=t(1==i?".subTask[data-id='"+e+"']":"#taskList .list-group-item[data-id='"+e+"']"),l=t(this).index();if(1==i){var d=o.parent("td"),c=t(this),p=t(this).parent(),h=parseInt(d.attr("colspan")),f=0;if(p.children("td:not(:first-child)").each(function(a,e){return l-1>a?void 0:a>l+h-1||"&nbsp;"!=t(e).html()&&t(e).html()!=d.html()?!1:void("&nbsp;"!=t(e).html()&&t(e).html()==d.html()?f+=parseInt(d.attr("colspan")):f++)}),h>f)return;d.attr("colspan",1),c.attr("colspan",h);for(var g=0;h-1>g;g++)d.after("<td>&nbsp;</td>");var v=p.children("td:eq(0)").data("id"),b=moment().set({year:u.year(),month:u.month(),date:u.date(),hour:r.firstHour,minute:0,second:0}).add(60*(l-1)*r.accuracy,"m").format(r.dateFormat),k=moment(b).add(60*h*r.accuracy,"m").format(r.dateFormat);o.attr("data-start",b),o.attr("data-end",k),o.attr("data-resource",v),c.html("").append(o),d.html("&nbsp;");for(var g=0;h-1>g;g++)c.next().remove();for(var T=0;T<m.length;T++)if(m[T].id==o.data("id")){m[T].resource=v,m[T].start=b,m[T].end=k,null!=r.onUpdate&&r.onUpdate(m[T]);break}}else{var p=t(this).parent(),D=n.getTimeUnit(),f=0;if(p.children("td:not(:first-child)").each(function(a,e){return l-1>a?void 0:a>l+D-1||"&nbsp;"!=t(e).html()?!1:void f++}),D>f)return;var v=p.children("td:eq(0)").data("id"),b=moment().set({year:u.year(),month:u.month(),date:u.date(),hour:r.firstHour,minute:0,second:0}).add(60*(l-1)*r.accuracy,"m").format(r.dateFormat),k=moment(b).add(60*D*r.accuracy,"m").format(r.dateFormat),d=t(this);d.html('<div class="subTask" draggable="true" data-id="'+o.data("id")+'" data-name="'+o.data("name")+'" data-address="'+o.data("address")+'" data-lat="'+o.data("lat")+'" data-lng="'+o.data("lng")+'" data-customer="'+o.data("customer")+'" data-resource="'+v+'" data-start="'+b+'" data-end="'+k+'" data-toggle="tooltip" data-placement="top" title="'+o.data("name")+'"><span class="text">'+o.data("name")+'</span> <a href="#"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></a> <div class="ttDrag" draggable="false"></div></div>'),d.attr("colspan",D);for(var g=0;D-1>g;g++)d.next().remove();s(d.children(".subTask"));for(var T=0;T<m.length;T++)if(m[T].id==o.data("id")){m[T].resource=v,m[T].start=b,m[T].end=k,null!=r.onUpdate&&r.onUpdate(m[T]);break}o.remove()}}}),t("body").on("dragover","#ttTable tr td:gt(0), #ttTop .panel",function(a){if(t(this).is("td")&&"&nbsp;"!=t(this).html())return a.originalEvent.dataTransfer.dropEffect="none",!1;if(t(this).is("td")){var e=a.originalEvent.dataTransfer.getData("timeTable"),s=a.originalEvent.dataTransfer.getData("timeTableMove"),r=t(1==s?".subTask[data-id='"+e+"']":"#taskList .list-group-item[data-id='"+e+"']"),i=t(this).index();if(1==s){var o=r.parent("td"),l=(t(this),t(this).parent()),d=parseInt(o.attr("colspan")),c=0;if(l.children("td:not(:first-child)").each(function(a,e){return i-1>a?void 0:a>i+d-1||"&nbsp;"!=t(e).html()&&t(e).html()!=o.html()?!1:void("&nbsp;"!=t(e).html()&&t(e).html()==o.html()?c+=parseInt(o.attr("colspan")):c++)}),d>c)return a.originalEvent.dataTransfer.dropEffect="none",!1}else{var l=t(this).parent(),p=n.getTimeUnit(),c=0;if(l.children("td:not(:first-child)").each(function(a,e){return i-1>a?void 0:a>i+p-1||"&nbsp;"!=t(e).html()?!1:void c++}),p>c)return a.originalEvent.dataTransfer.dropEffect="none",!1}}a.originalEvent.dataTransfer.dropEffect="move",a.preventDefault()}),t("body").on("drop","#ttTop .panel",function(a){a.preventDefault();var e=a.originalEvent.dataTransfer.getData("timeTable"),n=a.originalEvent.dataTransfer.getData("timeTableMove");if(1==n){for(var s=t(".subTask[data-id='"+e+"']"),i=s.parent("td"),o=0;o<m.length;o++)if(m[o].id==e){m[o].resource=null,t("#taskList").append('<a href="#" class="list-group-item" draggable="true" data-id="'+m[o].id+'" data-name="'+m[o].name+'" data-address="'+m[o].address+'" data-lat="'+m[o].lat+'" data-lng="'+m[o].lng+'" data-customer="'+m[o].customer+'" data-start="'+m[o].start+'" data-end="'+m[o].end+'"> <h4 class="list-group-item-heading">'+m[o].name+'</h4> <p class="list-group-item-text">'+m[o].address+"</p></a>"),null!=r.onUpdate&&r.onUpdate(m[o]);break}for(var l=parseInt(i.attr("colspan")),d=1;l>d;d++)i.after("<td>&nbsp;</td>");i.attr("colspan",1),i.html("&nbsp;")}})},_initGoogleMaps:function(){l=new google.maps.Map(e.getElementById("mapWidget"),{zoom:7,center:{lat:49.81,lng:15.5}})},_load:function(a){for(var e=this.options,i="",o=0;o<this.getColumns();o++)i+="<td>&nbsp;</td>";d=[],t("#ttTable").find("tr:gt(0)").remove(),t("#taskList").html("");for(var l=0;l<p.length;l++){var c="<td data-id='"+p[l].id+"' data-lat='"+r(p[l].lat)+"' data-lng='"+r(p[l].lng)+"'>"+p[l].name+"</td>";c+=i,t("#ttTable").append("<tr>"+c+"</tr>"),r(p[l].lat)&&r(p[l].lng)&&d.push(t.makeArray({lat:p[l].lat,lng:p[l].lng,title:p[l].name,task:!1}))}for(var u=0;u<m.length;u++)null==m[u].resource&&(t("#taskList").append('<a href="#" class="list-group-item" draggable="true" data-id="'+m[u].id+'" data-name="'+m[u].name+'" data-address="'+m[u].address+'" data-lat="'+m[u].lat+'" data-lng="'+m[u].lng+'" data-customer="'+m[u].customer+'" data-start="'+m[u].start+'" data-end="'+m[u].end+'"> <h4 class="list-group-item-heading">'+m[u].name+'</h4> <p class="list-group-item-text">'+m[u].address+"</p></a>"),d.push(t.makeArray({lat:m[u].lat,lng:m[u].lng,title:m[u].name,task:!0,taskID:m[u].id})));for(var h=moment().set({year:a.year(),month:a.month(),date:a.date(),hour:e.firstHour,minute:0,second:0}),u=0;u<m.length;u++)if(null!=m[u].resource){var f=moment(m[u].start);if(f.format("MM/DD/YYYY")==a.format("MM/DD/YYYY")){var g=moment(m[u].end),v=moment(g.diff(f)).minutes()+60*(moment(g.diff(f)).hours()-1),b=Math.round(v/(60/(1/e.accuracy))),k=(this.getColumns(),Math.round((moment(f.diff(h)).minutes()+60*(moment(f.diff(h)).hours()-1))/(60/(1/e.accuracy)))),T=t("#ttTable tr td[data-id='"+m[u].resource+"']:first-child").closest("tr"),D=0,y=0;T.children("td:not(:first-child)").each(function(a,e){return y+=t(e).attr("colspan")===n?1:parseInt(t(e).attr("colspan")),D=a,y>k?!1:void 0});var M=T.children("td:eq("+(D+1)+")");M.html('<div class="subTask" draggable="true" data-id="'+m[u].id+'" data-name="'+m[u].name+'" data-address="'+m[u].address+'" data-lat="'+m[u].lat+'" data-lng="'+m[u].lng+'" data-customer="'+m[u].customer+'" data-resource="'+m[u].resource+'" data-start="'+m[u].start+'" data-end="'+m[u].end+'" data-toggle="tooltip" data-placement="top" title="'+m[u].name+'"><span class="text">'+m[u].name+'</span> <a href="#"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></a> <div class="ttDrag" draggable="false"></div></div>'),M.attr("colspan",b);for(var o=0;b-1>o;o++)M.next().remove();s(M.children(".subTask")),d.push(t.makeArray({lat:m[u].lat,lng:m[u].lng,title:m[u].name,task:!0,taskID:m[u].id}))}}t('[data-toggle="tooltip"]').tooltip();var w=[];t.each(d,function(a,e){-1===t.inArray(e,w)&&w.push(e)}),d=w,this.clearMarkers()},addMarker:function(t,a,e){var s=new google.maps.Marker({map:l,title:t,position:new google.maps.LatLng(a,e),task:!1,taskID:n});c.push(s)},clearMarkers:function(){for(var t=0;t<c.length;t++)c[t].setMap(null);c=[]},closeDetails:function(){D&&D.close()},getColumns:function(){return(this.options.lastHour-this.options.firstHour+1)*(1/this.options.accuracy)},getTimeUnit:function(){return this.options.timeUnit/this.options.accuracy},getCustomers:function(){var a=[];return t("#ttTable tr td:eq(0)").each(function(e,n){var s=t(n),r=[];r.id=s.data("id"),r.title=s.children("h4").text(),r.lat=s.data("lat"),r.lng=s.data("lng"),r.tasks=getCustomerTasks(r.id),a.push(r)}),a},getCustomerTasks:function(a){var e=[],n=t("#ttTable tr td[data-id='"+a+"']").eq(0).closest("tr");return t(n+"td:gt(0)").each(function(n,s){var r=t(s),i=[];i.id=r.data("id"),i.title=r.data("title"),i.address=r.data("address"),i.lat=r.data("lat"),i.lng=r.data("lng"),i.customer=r.data("customer"),i.customerID=a,i.startDateTime=r.data("startDateTime"),i.endDateTime=r.data("endDateTime"),i.length=r.data("length"),e.push(i)}),e},getTasks:function(){var a=[];return t("taskList .list-group-item").each(function(t,e){var n=[];a.push(n)}),a},getMap:function(){return l},refresh:function(t,a,e){m=a,p=t,u=moment(e),this._load(u),this.showMarkers()},options:function(t,a){return a?void(this.options[t]=a):this.options[t]},showDetails:function(t,a,e){var n='<div id="content" style="min-width:300px"><div id="siteNotice"></div><h1 id="firstHeading" class="firstHeading">'+a.name+'</h1><div id="bodyContent"><form class="form-horizontal"><div class="form-group"><label class="col-sm-4 control-label">Název</label><div class="col-sm-8"><p class="form-control-static">'+a.name+'</p></div></div><div class="form-group"><label class="col-sm-4 control-label">Adresa</label><div class="col-sm-8"><p class="form-control-static">'+a.address+'</p></div></div><div class="form-group"><label class="col-sm-4 control-label">Zákazník</label><div class="col-sm-8"><p class="form-control-static">'+a.customer+'</p></div></div><div class="form-group"><label class="col-sm-4 control-label">Zdroj</label><div class="col-sm-8"><p class="form-control-static">'+e+'</p></div></div><div class="form-group"><label class="col-sm-4 control-label">Čas</label><div class="col-sm-8"><p class="form-control-static">'+(null==a.start?"":a.start)+" - "+(null==a.end?"":a.end)+"</p></div></div></form></div></div>";D=new google.maps.InfoWindow({content:n}),D.open(l,t)},showMarkers:function(){var t=this;setTimeout(function(){null==l?t.showMarkers():t._showMarkers()},500)},_showMarkers:function(){for(var a=this,e=0;e<d.length;e++){var n=d[e][0].task?'<span class="map-icon map-icon-general-contractor"></span>':'<span class="map-icon map-icon-male"></span>',s=new Marker({map:l,title:d[e][0].title,position:new google.maps.LatLng(d[e][0].lat,d[e][0].lng),task:d[e][0].task,taskID:d[e][0].taskID,icon:{path:MAP_PIN,fillColor:d[e][0].task?"#4CD964":"#FF3A2D",fillOpacity:.8,strokeColor:"",strokeWeight:0},map_icon_label:n});google.maps.event.addListener(s,"click",function(){if(D&&D.close(),this.task)for(var e=0;e<m.length;e++)if(m[e].id==this.taskID){var n=m[e].customer;null!=m[e].resource&&(n=t("#ttTable tr td[data-id='"+m[e].resource+"']:first-child").text()),a.showDetails(this,m[e],n);break}}),c.push(s)}this.zoomOut()},zoomOut:function(){for(var t=new google.maps.LatLngBounds,a=0;a<c.length;a++)t.extend(c[a].getPosition());l.fitBounds(t)}},i.defaults={accuracy:1,timeUnit:1,dateFormat:"YYYY-MM-DD HH:mm:ss",firstHour:8,lastHour:18,minMapHeight:300,zoomOnClick:!1,resources:null,events:null,onUpdate:null,onDateChange:null},a.timeTable=function(a,e){var n=new i(t(a),e);return n._init(),n},t.fn.timeTable=function(e){return a.timeTable(t(this),e)}}(window.jQuery,window,document);